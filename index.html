<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.7.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" 
      href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" 
      integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" 
      crossorigin="anonymous">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script
			  src="https://code.jquery.com/jquery-3.4.1.js"
			  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
			  crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/animate.css" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js" ></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.9/dist/css/bootstrap-select.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.12/js/bootstrap-select.min.js"></script>
</head>
<body>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
    <link
            rel="stylesheet"
            href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css"
            type="text/css"
    />
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    <div class="menu">
        <div class="btn-group-vertical">
            <button type="button" class="btn btn-dark">Home</button>
            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#dashboardModal">Dashboard</button>
            <button type="button" class="btn btn-dark" data-toggle="modal" data-target="#formModal">Add new case</button>
            <select name="disease" id="diseasesMenu" onchange="loadDiseases1(this.value)" class="selectpicker">
            </select>
            <div class="invalid-feedback">Example invalid custom select feedback</div>
        </div>
    </div>
    <div id='map'></div>
    <div class="modal" id="formModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content animated bounceInDown fast">
            
            <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">New case</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger fade show" role="alert" id="alert" style="display: none;">
                    You need fill all the field
                </div>
                <div class="loader" id="loader"></div>
                <div class="check" id="check">
                    <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                        <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                        <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                    </svg>
                    <p style="text-align: center;">Case added sucessfully</p>
                </div>
                <div id="content">
                    <form id="form" method="POST">
                        <div class="form-group">
                            <label for="first-name" class="col-form-label">First name:</label>
                            <input type="text" name="firstName" class="form-control" id="fisrt-name">
                            <label for="last-name" class="col-form-label">Last name:</label>
                            <input type="text" class="form-control" id="last-name" name="lastName">
                        </div>
                        <div class="row">
                            <div class="form-group col">
                                <label class="form-check-label">Gender</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="gender" id="maleRadio" value="true">
                                    <label class="form-check-label" for="maleRadio">Male</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="gender" id="femaleRadio" value="false">
                                    <label class="form-check-label" for="femaleRadio">Female</label>
                                </div>
                            </div>
                            <div class="form-group col">
                                <label for="age">Age</label>
                                <input type="number" name="age" id="age" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <select class="selectpicker" name="disease" id="diseasesForm" data-live-search="true"  data-width="100%">
                                <option value="">Select the disease</option>
                            </select>
                            <div class="invalid-feedback">Example invalid custom select feedback</div>
                        </div>
                        <div class="form-group row">
                            <div class="col">
                                <label for="date">Date</label>
                            <input type="date" name="date" id="date" class="form-control">
                            </div>
                            <div class="col">
                                <label for="geocoder">Adress</label>
                                <div id="geocoder" class="geocoder"></div>
                            </div>
                            
                        </div>
                        <div class="form-group">
                            
                        </div>
                        <input type="text" name="latitude" id="lat" hidden>
                        <input type="text" name="longitude" id="lng" hidden>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="postCase()">Save case</button>
            </div>
        </div>
        </div>
    </div>
    <div class="modal" id="dashboardModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="dialog">
            <div class="modal-content animated bounceInDown fast">
                <div class="modal-header">
                    <h5 class="modal-title">Dashboard</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true" >&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <canvas id="myChart" width="100%" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    <script>
        loadDiseases();
        function loadDiseases(){
            var xhttp = new XMLHttpRequest();
            var responseJson;
            
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    loadSelects(this);
                }
            };
            xhttp.open("GET", "http://54.211.232.101:8080/api/", false);
            xhttp.send();
        }
        function loadSelects(json){
            responseJson = JSON.parse(json.responseText);
            JsonToSelect(responseJson,document.getElementById("diseasesMenu"),true);
            JsonToSelect(responseJson,document.getElementById("diseasesForm"));
        }
        function JsonToSelect(json,select,random){
            var selected = Math.floor((Math.random() * json.length));
            for(var i=0;i<json.length;i++){
                var option = document.createElement("option");
                option.text = json[i];
                option.value = json[i];
                if(selected == i && random){
                    option.selected = "selected"
                }
                select.options.add(option);
                
            }
            console.log(json);
        }

    </script>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidHdvemVyMDAiLCJhIjoiY2s2NGRoamZ4MGphczNrcXA1NWw4dzN5MyJ9.-KxY1BPMApriPjGoMevTWg';
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-96, 37.8], // starting position
        zoom:3
    });
    
    map.on('load', function() {
// Add a geojson point source.
// Heatmap layers also work with a vector tile source.
        var selected = document.getElementById("diseasesMenu").value;
        map.addSource('diseases', {
        type: 'geojson',
        // Point to GeoJSON data. This example visualizes all M1.0+ earthquakes
        // from 12/22/15 to 1/21/16 as logged by USGS' Earthquake hazards program.
        data:
        'http://54.211.232.101:8080/api/' + selected  ,
        cluster: true,
        clusterMaxZoom: 14, // Max zoom to cluster points on
        clusterRadius: 30 // Radius of each cluster when clustering points (defaults to 50)
        });

        map.addLayer({
            id: 'clusters',
            type: 'circle',
            source: 'diseases',
            filter: ['has', 'point_count'],
            paint: {
            // Use step expressions (https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
            // with three steps to implement three types of circles:
            //   * Blue, 20px circles when point count is less than 100
            //   * Yellow, 30px circles when point count is between 100 and 750
            //   * Pink, 40px circles when point count is greater than or equal to 750
            'circle-color': [
            'step',
            ['get', 'point_count'],
            '#feda47',
            100,
            '#ff7800',
            750,
            '#ff0000'
            ],
            'circle-radius': [
            'step',
            ['get', 'point_count'],
            20,
            100,
            30,
            750,
            40
            ]
            }
            });
            
            map.addLayer({
            id: 'cluster-count',
            type: 'symbol',
            source: 'diseases',
            filter: ['has', 'point_count'],
            layout: {
            'text-field': '{point_count_abbreviated}',
            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
            'text-size': 12
            }
            });
            
            map.addLayer({
            id: 'unclustered-point',
            type: 'circle',
            source: 'diseases',
            filter: ['!', ['has', 'point_count']],
            paint: {
            'circle-color': '#ff0000',
            'circle-radius': 4,
            'circle-stroke-width': 1,
            'circle-stroke-color': '#fff'
            }
            });
            // inspect a cluster on click
            map.on('click', 'clusters', function(e) {
            var features = map.queryRenderedFeatures(e.point, {
            layers: ['clusters']
            });
            var clusterId = features[0].properties.cluster_id;
            map.getSource('diseases').getClusterExpansionZoom(
            clusterId,
            function(err, zoom) {
            if (err) return;
            
            map.easeTo({
            center: features[0].geometry.coordinates,
            zoom: zoom
            });
            }
            );
            });
            
            // When a click event occurs on a feature in
            // the unclustered-point layer, open a popup at
            // the location of the feature, with
            // description HTML from its properties.
            map.on('click', 'unclustered-point', function(e) {
            
            var coordinates = e.features[0].geometry.coordinates.slice();
            var mag = e.features[0].properties.mag;
            var tsunami;
            
            if (e.features[0].properties.tsunami === 1) {
            tsunami = 'yes'
            } else {
            tsunami = 'no'
            }
            
            // Ensure that if the map is zoomed out such that
            // multiple copies of the feature are visible, the
            // popup appears over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
            
            new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML("magnitude: " + mag + "<br>Was there a tsunami?: " + tsunami)
            .addTo(map);
            });
            
            map.on('mouseenter', 'clusters', function() {
            map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'clusters', function() {
            map.getCanvas().style.cursor = '';
            });
    });
    
    
    var geocoder = new MapboxGeocoder({
        accessToken: mapboxgl.accessToken,
        Marker:{
            color:"black",
            draggable:true
        },
        mapboxgl: mapboxgl
    });
    geocoder.on('result',getCoor);
    
    function getCoor(){
        document.getElementById("lat").value = geocoder.mapMarker._lngLat.lat;
        document.getElementById("lng").value = geocoder.mapMarker._lngLat.lng;
    }
    document.getElementById('geocoder').appendChild(geocoder.onAdd(map));
    </script>
    <script>
        function postCase(){
            var form = document.getElementById("form");
            var formData = new FormData(form);
            var object = {};
            formData.forEach((value, key) => {object[key] = value});
            var validator=true;
            for (var key in object) {
                if (object.hasOwnProperty(key)) {
                    var val = object[key];
                    if(key==="latitude" && val===""){
                        validator=false;
                    }
                    if(key==="disease" && val ===""){
                        validator=false;
                    }
                }
            }
            if(validator){
                document.getElementById("loader").style.display = "block";
                document.getElementById("content").style.display = "none";
                var json = JSON.stringify(object);
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 201) {
                        document.getElementById("form").reset();
                        document.getElementById("loader").style.display = "none";
                        document.getElementById("check").style.display = "block";
                        setTimeout(function(){
                            document.getElementById("content").style.display = "block";
                            document.getElementById("check").style.display = "none";
                            $('#formModal').modal('hide');
                            geocoder._removeMarker();
                        },1500);
                    }
                };
                xhttp.open("POST", "http://54.211.232.101:8080/case", true);
                xhttp.setRequestHeader('Content-type', 'application/json');
                xhttp.send(json);
            }
            else{
                document.getElementById("alert").style.display = "block";
                setTimeout(function(){
                    $("#alert").alert('close');
                },3000);
            }
        }
    </script>
    <script>
        var ctx = document.getElementById('myChart');
        var data = [10,20,30,40,50];
        var myLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    data: [10, 20, 30, 40, 50, 60]
                }],
                labels: ['January', 'February', 'March', 'April', 'May', 'June']
            },
            options: {
                scales: {
                    xAxes: [{
                        ticks: {
                            min: 'March'
                        }
                    }]
                }
            }   
        });
    </script>
    <script>
        function loadDiseases1 (select){
            map.getSource("diseases").setData("http://54.211.232.101:8080/api/" + select);
        }
    </script>
</body>
</html>